<template>
  <div class="dashboard">
    <!-- Dashboard Header & Back to Settings button -->
    <div class="dashboard-header">
      <BaseButton
        v-if="gameSettings.stepCounter !== 3"
        class="settings-bttn danger has-small-top-margin"
        @clicked="toggleAlertBox(true)"
      >
        <span>
          {{ $t("pages.home.changeSettings") }}
        </span>
      </BaseButton>
    </div>
    <!-- Confirmation Alert for change settings -->
    <Overlay
      :class="{
        active: alertBox,
        dialog: true
      }"
    >
      <img
        class="has-xsmall-bottom-margin"
        src="@/assets/images/icons/warning.svg"
        :alt="$t('general.warningIcon')"
      />
      <p>
        {{ $t("pages.home.changeSettingsText") }}
      </p>
      <BaseButton class="green" @clicked="changeGameSettings()">
        <span>
          {{ $t("pages.home.confirmButton") }}
        </span>
      </BaseButton>
      <BaseButton class="danger" @clicked="toggleAlertBox(false)">
        <span>
          {{ $t("pages.home.cancelButton") }}
        </span>
      </BaseButton>
    </Overlay>
    <transition name="slide" mode="out-in">
      <!-- Input to write name of players -->
      <PageBox v-if="gameSettings.stepCounter === 1" class="has-top-padding" key="step1">
        <!-- Use Pre Defined names for players -->
        <a
          href="javascript:void(0)"
          class="predefined right-button"
          :class="{
            active: showPredefined
          }"
          @click="togglePredefinedNames()"
        >
          <span>
            {{ $t("pages.home.defaultNames") }}
          </span>
        </a>
        <!-- Load last game players -->
        <a
          v-if="checkUsers"
          href="javascript:void(0)"
          class="predefined type-2 left-button"
          :class="{
            active: showSavedNames
          }"
          @click="toggleSavedNames()"
        >
          <span>
            {{ $t("pages.home.lastNames") }}
          </span>
        </a>
        <br />
        <p class="important-hint">
          {{ $t("pages.home.nameExtraHint") }}
        </p>
        <input
          v-for="(roleInput, index) in gameSettings.selectedRoles"
          @keyup.enter="$event.target.nextElementSibling.focus()"
          type="text"
          class="has-xsmall-bottom-margin"
          :key="index"
          v-model="players[index]"
        />
        <BaseButton class="primary assign-bttn" @clicked="assignRoles()">
          <span>
            {{ $t("pages.home.assign") }}
          </span>
        </BaseButton>
      </PageBox>
      <!-- Show each player their randomly chosen character -->
      <PageBox v-else-if="gameSettings.stepCounter === 2" class="display autoheight" key="step2">
        <div class="inner-display">
          <ShowGrid />
        </div>
      </PageBox>
      <!-- Show God Panel When each player knows his role -->
      <GodPanel v-else-if="gameSettings.stepCounter === 3" key="step3" />
    </transition>
  </div>
</template>

<script>
import GodPanel from "@/components/GodPanel.vue";
import ShowBox from "@/components/ShowBox.vue";
import ShowGrid from "@/components/ShowGrid.vue";
import PageTitle from "@/components/PageTitle.vue";
import Random from "random-js";

export default {
  data() {
    return {
      players: [],
      showPredefined: false,
      showSavedNames: false,
      alertBox: false
    };
  },
  components: {
    GodPanel,
    ShowBox,
    PageTitle,
    ShowGrid
  },
  computed: {
    roles() {
      return JSON.parse(JSON.stringify(this.Roles));
    },
    checkUsers() {
      const savedPlayers = JSON.parse(localStorage.getItem("latest-players"));
      if (savedPlayers && savedPlayers.length > 0) {
        return true;
      }
      return false;
    }
  },
  methods: {
    assignRoles() {
      const chosenCharacters = this.gameSettings.selectedRoles;
      const playerNames = this.players;
      let readyToAssignRoles = false;
      let discordText = this.$t("thirdparty.discordPlayers");
      // Check inputs are not empty
      const checkPlayersInput = playerNames.filter(
        (item, index) => playerNames.indexOf(item) >= index
      );
      // Check if there is no duplicate names
      if (
        playerNames.length === chosenCharacters.length &&
        checkPlayersInput.length === playerNames.length
      ) {
        for (let i = 0; i < playerNames.length; i++) {
          if (playerNames[i].length < 1) {
            readyToAssignRoles = false;
            break;
          } else {
            readyToAssignRoles = true;
          }
        }
      } else {
        this.$notify({
          group: "log",
          type: "error",
          title: "error2.svg",
          text: `${this.$t("general.errors.uniquePlayers")}`,
          duration: 4000
        });
      }
      if (readyToAssignRoles) {
        // Randomize Characters in Array
        this.randomFunc();
        for (let i = chosenCharacters.length - 1; i >= 0; i--) {
          // Assign each player to one character
          chosenCharacters[i].player = playerNames[i];
        }
        this.gameSettings.stepCounter = 2;
        discordText += `• `;
        playerNames.forEach(name => {
          discordText += `${name} • `;
        });
        // Post Players To Discord
        this.postDiscord(discordText);
      }
      // Save Names to localStorage
      if (playerNames.length > 0) {
        localStorage.setItem("latest-players", JSON.stringify(playerNames));
      }
      this.SetGameSettings(this.gameSettings);
    },
    togglePredefinedNames() {
      if (this.showPredefined === false) {
        this.fillPreDefinedNames();
        this.showPredefined = true;
        this.showSavedNames = false;
      } else {
        this.players = [];
        this.showPredefined = false;
        this.showSavedNames = true;
      }
    },
    toggleSavedNames() {
      if (this.showSavedNames === false) {
        this.players = JSON.parse(localStorage.getItem("latest-players"));
        if (this.gameSettings.selectedRoles.length < this.players.length) {
          this.players = this.players.slice(0, this.gameSettings.selectedRoles.length);
        }
        this.showPredefined = false;
        this.showSavedNames = true;
      } else {
        this.players = [];
        this.showPredefined = true;
        this.showSavedNames = false;
      }
    },
    fillPreDefinedNames() {
      this.gameSettings.selectedRoles.forEach((name, index) => {
        this.players.push(`${this.$t("pages.home.playerDefault")} ${index + 1}`);
      });
    },
    toggleAlertBox(value) {
      this.alertBox = value;
    },
    changeGameSettings() {
      this.startGameEngine("roles-selected-create");
    },
    checkConsecutiveElements(array) {
      const length = array.length;
      for (let i = 0; i < length - 2; i++) {
        const elem1 = array[i].mafia;
        const elem2 = array[i + 1].mafia;
        const elem3 = array[i + 2].mafia;
        if (elem1 == true && elem1 == true && elem3 == true) {
          return true;
        }
      }
      return false;
    },
    randomFunc() {
      const random = new Random(Random.engines.mt19937().autoSeed());
      let isConsecutive;
      do {
        random.shuffle(this.gameSettings.selectedRoles);
        isConsecutive = this.checkConsecutiveElements(this.gameSettings.selectedRoles);
      } while (isConsecutive);
    },
    randomFunc2() {
      const random = new Random(Random.engines.mt19937().autoSeed());
      random.shuffle(this.gameSettings.selectedRoles);
    }
  }
};
</script>
